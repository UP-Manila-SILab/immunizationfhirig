name: Build FHIR IG (TEST)

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.18-8/x64

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Download IG Publisher
        run: |
          mkdir -p tools
          curl -L -o tools/publisher.jar https://github.com/HL7/fhir-ig-publisher/releases/latest/download/publisher.jar
          ls -l tools

      - name: Cache FHIR packages
        uses: actions/cache@v3
        with:
          path: ~/.fhir/packages
          key: ${{ runner.os }}-fhir-packages-${{ hashFiles('**/ig.ini') }}
          restore-keys: |
            ${{ runner.os }}-fhir-packages-
      
      - name: Show current directory
        run: pwd

      - name: List IG folder 
        run: ls -l

      - name: Build IG
        run: |
          echo "Current directory: $PWD"
          java -Xmx4g -jar tools/publisher.jar -ig PH-ImmunizationIG/ig.ini

      - name: Fail on QA errors
        run: |
          grep -q "ERROR" IG/PH-Immunization/output/qa.html && exit 1 || true