name: Build FHIR IG 

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout repo
      - uses: actions/checkout@v4

      # 2️⃣ Build Docker image locally
      - name: Build IG Docker image
        run: docker build -t fhir-sushi:latest docker/

      # 3️⃣ Run IG build inside container
      - name: Run IG build in Docker container
        run: |
          docker run --rm \
            -v $PWD:/workspace \
            -v $HOME/.fhir/packages:/root/.fhir/packages \
            fhir-sushi:latest bash -c "
              # Copy PH Core if not already cached
              mkdir -p /root/.fhir/packages/fhir.ph.core#1.0.0/package
              cp -r /workspace/tools/package/fhir.ph.core-1.0.0/package/* \
                     /root/.fhir/packages/fhir.ph.core#1.0.0/package/ || true
              
              # Download IG Publisher if not exists
              mkdir -p /workspace/tools
              if [ ! -f /workspace/tools/publisher.jar ]; then
                curl -L -o /workspace/tools/publisher.jar \
                  https://github.com/HL7/fhir-ig-publisher/releases/latest/download/publisher.jar
              fi

              # Run SUSHI and build IG
              sushi /workspace
              java -Xmx6g -jar /workspace/tools/publisher.jar -ig /workspace/ig.ini

              # QA check
              if [ -f /workspace/output/qa.html ]; then
                grep -q 'ERROR' /workspace/output/qa.html && echo 'QA errors found!' && exit 1 || echo 'No QA errors.'
              else
                echo 'QA file not found, skipping QA check.'
              fi
            "